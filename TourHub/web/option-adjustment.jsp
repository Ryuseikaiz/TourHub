<%@ page contentType="text/html; charset=UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ page contentType="text/html; charset=UTF-8" %>
<!DOCTYPE html>
<html class="wide wow-animation" lang="en">
  <head>
    <!-- Site Title-->
    <title>Home</title>
    <meta name="format-detection" content="telephone=no" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <link
      rel="icon"
      href="assests/images/logo-favicon/logo.png"
      type="image/x-icon"
    />
    <!-- Stylesheets -->
    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Oswald:200,400%7CLato:300,400,300italic,700%7CMontserrat:900"
    />
    <link rel="stylesheet" href="assests/css/bootstrap.css" />
    <link rel="stylesheet" href="assests/css/style.css" />
    <link rel="stylesheet" href="assests/css/fonts.css" />
    <link rel="stylesheet" href="assests/css/index.css" />
    <link rel="stylesheet" href="assests/css/option-adjustment.css" />

    <!-- Owl Carousel CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css"
    />

    <!-- jQuery (required for Owl Carousel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Owl Carousel JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/d14313468c.js"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Flatpickr CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />

    <!--<link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.2/dist/css/bootstrap.min.css">-->
    <!--[if lt IE 10]>
      <div
        style="
          background: #212121;
          padding: 10px 0;
          box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, 0.3);
          clear: both;
          text-align: center;
          position: relative;
          z-index: 1;
        "
      >
        <a href="http://windows.microsoft.com/en-US/internet-explorer/"
          ><img
            src="assests/images/ie8-panel/warning_bar_0000_us.jpg"
            border="0"
            height="42"
            width="820"
            alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today."
        /></a>
      </div>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
  </head>
</html>


<body class="search-page">
    <!-- Page-->
        <div class="page-loader"> 
        <div class="page-loader-body"> 
            <div class="preloader-wrapper big active"> 
                <div class="spinner-layer spinner-blue"> 
                    <div class="circle-clipper left">
                        <div class="circle"> </div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"> </div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"> </div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
                <div class="spinner-layer spinner-yellow"> 
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"> </div>
                    </div>
                </div>
                <div class="spinner-layer spinner-green"> 
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page">
        <!-- Page Header-->
        <header class="section page-header">
            <!-- RD Navbar-->
            <div class="rd-navbar-wrap rd-navbar-corporate">
                <nav class="rd-navbar" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-xl-layout="rd-navbar-static" data-lg-device-layout="rd-navbar-fixed" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="130px" data-lg-stick-up-offset="100px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
                    <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
                    <div class="rd-navbar-top-panel rd-navbar-collapse novi-background">
                        <div class="rd-navbar-top-panel-inner">
                            <ul class="list-inline">
                                <li class="box-inline list-inline-item"><span class="icon novi-icon icon-md-smaller icon-secondary mdi mdi-phone"></span>
                                    <ul class="list-comma">
                                        <li><a href="tel:#">1-800-1234-567</a></li>
                                        <li><a href="tel:#">1-800-6780-345</a></li>
                                    </ul>
                                </li>
                                <li class="box-inline list-inline-item"><span class="icon novi-icon icon-md-smaller icon-secondary mdi mdi-map-marker"></span><a href="#">2130 Fulton Street, San Diego, CA 94117-1080 USA</a></li>
                                <li class="box-inline list-inline-item"><span class="icon novi-icon icon-md-smaller icon-secondary mdi mdi-email"></span><a href="mailto:#">mail@demolink.org</a></li>
                            </ul>
                            <ul class="list-inline">
                                <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-facebook" href="#"></a></li>
                                <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-twitter" href="#"></a></li>
                                <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-instagram" href="#"></a></li>
                                <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-google-plus" href="#"></a></li>
                                <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-linkedin" href="#"></a></li>
                            </ul>
                        </div>
                        <div class="rd-navbar-top-panel-inner"></div>
                    </div>
                    <div class="rd-navbar-inner">
                        <!-- RD Navbar Panel-->
                        <div class="rd-navbar-panel">
                            <!-- RD Navbar Toggle-->
                            <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                            <!-- RD Navbar Brand-->
                            <div class="rd-navbar-brand"><a class="brand-name" href="home"><img class="logo-default" src="assests/images/logo-favicon/logo.png" alt="" width="208" height="46"/><img class="logo-inverse" src="assests/images/logo-inverse-208x46.png" alt="" width="208" height="46"/></a></div>
                        </div>
                        <div class="rd-navbar-aside-center">
                            <div class="rd-navbar-nav-wrap">
                                <!-- RD Navbar Nav-->
                                <ul class="rd-navbar-nav">
                                    <li><a href="home">Home</a>
                                    </li>
                                    <li><a href="about-us.jsp">About Us</a>
                                    </li>
                                    <li><a href="contacts.jsp">Contacts</a>
                                    </li>
                                    <li><a href="typography.jsp">Typography</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="rd-navbar-aside-right"><a class="button button-sm button-secondary button-nina" href="#">Book a tour now</a></div>
                    </div>
                </nav>
            </div>
        </header>
     
        <div class="main-container flex" id="blur" style="margin-bottom: 50px">
            <div class="card-dis-container">
                <div class="card" style="height: fit-content;">
                    <img src="assests/images/new-image/CuChi-1.jpg" class="card-img" alt="">
                    <div class="tour-card-body">
                        <span class="card-title">
                            ${option.option_Name}
                        </span>
                        <br>
                        <span class="card-text">
                            ${option.option_Description}
                        </span>

                        <div class="card-change">
                            <span class="card-refund">
                                Không thể hoàn tiền
                            </span>
                            <span class="card-change-date">
                                Không thể đổi lịch
                            </span>
                        </div>

                        <div class="card-view-btn">
                            <button>Xem thông tin vé</button>
                        </div>
                    </div>
                </div>
                        
                <div class="discount-container">
                    <div class="discount-title">Voucher</div>
                    <c:forEach var="discount" items="${discounts}">
                        <div class="discount-detail-wrapper" style="justify-content: space-between;">
                        <div class="discount-detail">
                            <div class="discount-name">
                                <span class="discount-percent">${discount.percent_Discount.intValue()}</span>
                                % discount for bookings from
                                <span class="discount-require">${discount.require} </span>
                                people</div>
                            <div class="discount-slot">Available: ${discount.quantity}</div>
                            <div class="discount-day" style="font-weight: 600; font-size: 12px; color: #808080;">
                                Valid from: 
                                <span class="start-Day">
                                    <fmt:formatDate value="${discount.start_Day}" pattern="dd-MM-yyyy"/>
                                </span> 
                                to 
                                <span class="start-Day">
                                    <fmt:formatDate value="${discount.end_Day}" pattern="dd-MM-yyyy"/>
                                </span>
                            </div>
                        </div>

                        <button class="discount-btn" data-start="${discount.start_Day}" data-end="${discount.end_Day}" onclick="selectDiscount('${discount.discount_Id}')">Choose</button>
                    </div>
                    </c:forEach>
                </div>       
            </div>
        

        <div class="option-adjustment">

            <%
            // Get the previous selected date from the request attribute
                String previousSelectedDate = (String) request.getAttribute("previousSelectedDate");

                // Check if previousSelectedDate is not null
                if (previousSelectedDate != null) {
                    // Parse the date from the format yyyy-MM-dd
                    java.text.SimpleDateFormat inputFormat = new java.text.SimpleDateFormat("yyyy-MM-dd");
                    java.util.Date date = inputFormat.parse(previousSelectedDate);

                    // Create output format to display the date as Monday, 28 Oct 2024
                    java.text.SimpleDateFormat outputFormat = new java.text.SimpleDateFormat("EEEE, dd MMM yyyy", java.util.Locale.ENGLISH);

                    // Format the date
                    String formattedDate = outputFormat.format(date);

                    // Set the formatted date as an attribute to be used in the HTML
                    previousSelectedDate = formattedDate;
                }
            %>

            <!-- Display formatted date in the selected-date span -->
            <div class="selected-date-container">
                <span class="selected-date-title">Selected date</span>
                <br>
                <span class="selected-date">
                    <%= previousSelectedDate != null ? previousSelectedDate : "No date selected" %>
                </span>
            </div>

            <div class="people-adjust-container">
                <c:forEach var="people" items="${peopleList}">
                    <span class="optionId" style="display: none;">${people.optionId}</span>
                    <div class="people-container" style="display: flex; justify-content: space-between; align-items: center; border-bottom: solid 1px #c3c3c391;">
                        <div class="people-infomation" data-price="${people.price}" data-people-id="${people.peopleId}" style="display: flex; flex-direction: column; padding: 20px 0px;">
                            <span class="people-title" style="font-weight: 600; font-size: 20px; color: #808080;">
                                ${people.peopleType}
                            </span>
                            <span class="people-price" style="font-size: 25px; font-weight: 700;">
                                <fmt:formatNumber value="${people.price}" groupingUsed="true"/> VND
                            </span>
                            <span class="people-condition" style="font-weight: 600; font-size: 13px; color: #808080;">
                                ${people.description}
                            </span>
                        </div>

                        <div class="counter-container">
                            <div class="adjust-button" id="decrement-${people.peopleId}">-</div>
                            <div class="counter-display" id="counter-${people.peopleId}" data-count="${people.minCount}" data-min-count="${people.minCount}" data-max-count="${people.maxCount}" data-people-type="${people.peopleType}">${people.minCount}</div>
                            <div class="adjust-button" id="increment-${people.peopleId}">+</div>
                        </div>
                    </div>
                </c:forEach>
            </div>

            <div class="total-cost-container" style="display: flex; justify-content: space-between; align-items: center;">
                <div class="total-cost-left-sec-container">
                    <div class="total-cost-left-sec">
                        <div class="total-cost-left-sec-above">
                            <span class="total-cost-title" >You must pay</span>
                            <br>
                            <span class="total-cost"></span>
                        </div>

                        <div class="total-cost-left-sec-below">
                            <p class="d-inline-flex gap-1">
                                <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapseExample"
                                    role="button" aria-expanded="false" aria-controls="collapseExample"
                                    style="color: black; background-color: transparent; border: none;">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </a>
                            </p>
                        </div>
                    </div>

                    <div class="collapse" id="collapseExample">
                        <div class="card card-body" style="border: none; padding: 5px;">
                            <div class="cost-detail-container">
                                <div class="cost-detail">
                                    <c:forEach var="people" items="${peopleList}">
                                        <div class="people-cost-detail" id="${people.peopleId}-cost-detail">
                                            <span class="text-cost-detail">
                                                ${people.peopleType} (<span id="${people.peopleId}-num-detail">${people.minCount}</span>x)
                                            </span>
                                               <span class="total-cost-detail" id="${people.peopleId}-total-cost-detail"></span>
                                        </div>
                                    </c:forEach>
                                    <div class="total-no-discount-container" style="display: flex; justify-content: space-between; margin-top: 10px;">
                                        <span class="total-no-discount-text" style="font-size: 17px; font-weight: 600; color: black;">Total</span>
                                        <span class="total-no-discount" style="font-size: 17px; font-weight: 700; color: #FF5E1F;"></span>
                                    </div>
                                    <div class="discount-cost" style="display: flex; justify-content: space-between;">
                                        <span class="discount-text" style="font-weight: 600; color: gray;">Discount</span>
                                        <span class="total-discount" style="font-weight: 700; color: black;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="book-now-btn">Book now</button>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>    
        // Biến toàn cục lưu trữ phần trăm giảm giá đã chọn và điều kiện giảm giá đã chọn
        let selectedDiscountPercent = 0;
        let selectedDiscountRequire = 0;  // Điều kiện số lượng người của voucher đã chọn
        let currentTotalCost = 0; // Biến toàn cục lưu tổng giá tiền
        
        // Hàm tính toán tổng giá tiền của tất cả người với giảm giá nếu có
        function calculateTotalCost() {
            let totalCost = 0;
            const peopleContainers = document.querySelectorAll('.people-container');
            let totalPeopleCount = 0;

            peopleContainers.forEach(container => {
                const peopleInfo = container.querySelector('.people-infomation');
                const counterDisplay = container.querySelector('.counter-display');

                if (!peopleInfo || !counterDisplay) {
                    console.error("Cannot find people-infomation or counter-display in container:", container);
                    return;
                }

                const price = parseFloat(peopleInfo.getAttribute('data-price'));
                const count = parseInt(counterDisplay.getAttribute('data-count'));
                const peopleId = peopleInfo.getAttribute('data-people-id');
                const totalPeopleCost = price * count;

                // Tính tổng số lượng người để kiểm tra điều kiện giảm giá
                totalPeopleCount += count;

                const getElementIdCost = peopleId + '-total-cost-detail';
                const totalCostDetailElement = document.getElementById(getElementIdCost);

                if (totalCostDetailElement) {
                    totalCostDetailElement.textContent = formatCurrency(totalPeopleCost);
                } else {
                    console.error(`Cannot find #${peopleId}-total-cost-detail to display total cost.`);
                }

                totalCost += totalPeopleCost;
            });

            // Kiểm tra điều kiện của giảm giá đã chọn
            let discountAmount = 0;
            if (totalPeopleCount >= selectedDiscountRequire && selectedDiscountPercent > 0) {
                discountAmount = (totalCost * selectedDiscountPercent) / 100;
            } else {
                // Nếu không đạt điều kiện, bỏ giảm giá đã chọn
                selectedDiscountPercent = 0;
                selectedDiscountRequire = 0;
            }

            const totalAfterDiscount = totalCost - discountAmount;
            
            // Update the global variable with the calculated total cost after discount
            currentTotalCost = totalCost;

            // Cập nhật hiển thị cho tổng tiền và tiền giảm
            const totalDiscountElement = document.querySelector('.total-discount');
            const totalCostElement = document.querySelector('.total-cost');
            const totalCostNoDiscountElement = document.querySelector('.total-no-discount');
            
            
            if (totalDiscountElement) {
                totalDiscountElement.textContent = '-' + formatCurrency(discountAmount);
            }
            
            if (totalCostNoDiscountElement) {
                totalCostNoDiscountElement.textContent = formatCurrency(totalCost);
            }

            if (totalCostElement) {
                totalCostElement.textContent = formatCurrency(totalAfterDiscount);
            } else {
                console.error("Cannot find .total-cost to display the total cost.");
            }
        }

        // Thêm sự kiện cho nút giảm giá
        function setupDiscountButtons() {
            const discountButtons = document.querySelectorAll('.discount-btn');

            discountButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const discountContainer = this.closest('.discount-detail-wrapper');
                    const discountPercentElement = discountContainer.querySelector('.discount-percent');
                    const discountRequireElement = discountContainer.querySelector('.discount-require');

                    selectedDiscountPercent = parseFloat(discountPercentElement ? discountPercentElement.textContent : 0);
                    selectedDiscountRequire = parseInt(discountRequireElement ? discountRequireElement.textContent : 0);

                    // Tính lại tổng giá với giảm giá
                    calculateTotalCost();
                });
            });
        }

        // Hàm format tiền tệ (ví dụ: 1,000,000 VND)
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' VND';
        }

        // Hàm kiểm tra và kích hoạt nút giảm giá nếu ngày hiện tại nằm trong khoảng hợp lệ
        function checkAndActivateDiscount() {
            const discountContainers = document.querySelectorAll('.discount-detail-wrapper');
            let totalPeopleCount = 0;

            const peopleContainers = document.querySelectorAll('.people-container');
            peopleContainers.forEach(container => {
                const counterDisplay = container.querySelector('.counter-display');
                const peopleType = container.querySelector('.people-title').textContent;

                if (peopleType.includes("Người lớn") || peopleType.includes("Trẻ em")) {
                    totalPeopleCount += parseInt(counterDisplay.getAttribute('data-count'));
                }
            });

            // Ngày hiện tại
            const today = new Date();

            discountContainers.forEach(discountContainer => {
                const discountBtn = discountContainer.querySelector('.discount-btn');
                const discountRequire = parseInt(discountContainer.querySelector('.discount-require').textContent.trim());

                // Lấy ngày bắt đầu và ngày kết thúc từ các thuộc tính data-start và data-end
                const startDateStr = discountBtn.getAttribute('data-start');
                const endDateStr = discountBtn.getAttribute('data-end');

                // Chuyển đổi chuỗi ngày sang đối tượng Date
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);

                // Kiểm tra ngày hiện tại có nằm trong khoảng [startDate, endDate] và số người đạt yêu cầu
                const isWithinDateRange = today >= startDate && today <= endDate;
                const meetsPeopleRequirement = totalPeopleCount >= discountRequire;

                // Kích hoạt nút nếu cả hai điều kiện đều thỏa mãn
                discountBtn.disabled = !(isWithinDateRange && meetsPeopleRequirement);
                discountBtn.style.backgroundColor = discountBtn.disabled ? 'gray' : '';
            });
        }

        // Hàm cập nhật số lượng và giá tiền khi nhấn nút tăng/giảm
        function setupCounterListeners() {
            const adjustButtons = document.querySelectorAll('.adjust-button');

            adjustButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const peopleContainer = this.closest('.people-container');
                    const peopleInfo = peopleContainer.querySelector('.people-infomation');
                    const counterDisplay = peopleContainer.querySelector('.counter-display');

                    if (!peopleInfo || !counterDisplay) {
                        console.error("Cannot find people-infomation or counter-display in container:", peopleContainer);
                        return;
                    }

                    const peopleId = peopleInfo.getAttribute('data-people-id');
                    const minCount = parseInt(counterDisplay.getAttribute('data-min-count'));
                    const maxCount = parseInt(counterDisplay.getAttribute('data-max-count'));
                    let count = parseInt(counterDisplay.getAttribute('data-count'));

                    if (this.id.includes('increment') && count < maxCount) {
                        count++;
                    } else if (this.id.includes('decrement') && count > minCount) {
                        count--;
                    }

                    counterDisplay.textContent = count;
                    counterDisplay.setAttribute('data-count', count);

                    calculateTotalCost();
                    checkAndActivateDiscount();

                    const getElementIdNum = peopleId + '-num-detail';
                    const numDetailElement = document.getElementById(getElementIdNum);

                    if (numDetailElement) {
                        numDetailElement.textContent = count;
                    } else {
                        console.error(`Cannot find #${peopleId}-num-detail to update count.`);
                    }
                });
            });
        }

        // Khởi tạo các sự kiện lắng nghe khi trang được tải xong
        window.addEventListener('DOMContentLoaded', (event) => {
            setupCounterListeners();
            calculateTotalCost();
            checkAndActivateDiscount();
            setupDiscountButtons();
        });
    </script>
    
    <script>
        function selectDiscount(discountId) {
            // Lưu discountId vào localStorage
            localStorage.setItem("selectedDiscountId", discountId);
            console.log("Discount ID saved:", discountId);
        }
        
        document.querySelector('.book-now-btn').addEventListener('click', function() {
            // Gửi yêu cầu kiểm tra đăng nhập
            fetch('CheckLogin', { // Gọi đến servlet kiểm tra đăng nhập
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data.loggedIn) {
                    
                    // Nếu người dùng đã đăng nhập, tiếp tục quy trình đặt tour
                    const bookingData = proceedWithBooking();

                    const selectedDate = bookingData.selectedDate;
                    const totalCost = bookingData.totalCost;
                    const bookingDetail = bookingData.bookingDetail;
                    const optionId = bookingData.optionId;
                    const discountCost = bookingData.discountCost;
                    const discountId = localStorage.getItem("selectedDiscountId");
                    const totalCostNoDis = currentTotalCost;
                    

                    // Debug: Check if the values are retrieved correctly
                    console.log("Selected Date: ", selectedDate);
                    console.log("Total Cost: ", totalCost);
                    console.log("Booking Detail: ", bookingDetail);
                    console.log("Option ID: ", optionId);
                    console.log("Discount cost: ", discountCost);
                    console.log("Discount ID servlet: ", discountId);
                    console.log("Total no dis: ", totalCostNoDis);
                    
                    // Check for empty values before redirecting
                    if (!selectedDate || !totalCost || !bookingDetail || !optionId) {
                        console.error("One or more booking parameters are missing!");
                        return;
                    }

                    // Build the URL
                    const enCodeSelectedDate = encodeURIComponent(selectedDate);
                    const enCodeTotalCost = encodeURIComponent(totalCost);
                    const enCodeBookingDetail = encodeURIComponent(bookingDetail);
                    const enCodeOptionId = encodeURIComponent(optionId);

                    const bookingOverviewLink = 'BookingOverview?selectedDate=' + enCodeSelectedDate + 
                             '&totalCost=' + enCodeTotalCost + 
                             '&bookingDetail=' + enCodeBookingDetail + 
                             '&optionId=' + enCodeOptionId +
                             '&discountCost=' + discountCost +
                             '&discountId=' + discountId +
                             '&totalNoDis=' + totalCostNoDis;

                    // Redirect to BookingOverview with parameters
                    window.location.href = bookingOverviewLink;

                } else {
                    // Nếu người dùng chưa đăng nhập, chuyển hướng tới trang đăng nhập
                    window.location.href = 'login';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        function proceedWithBooking() {
            // Lấy ngày đã chọn
            const selectedDate = document.querySelector('.selected-date').innerText;
            let optionId = document.querySelector('.optionId').innerText;
            let discountCost = document.querySelector('.total-discount').innerText;

            const formattedSelectedDate = convertDateFormat(selectedDate);
            
            console.log(formattedSelectedDate);
            // Debug: Check if the optionId is correctly fetched
            console.log("Option ID: ", optionId);

            // Lấy tổng chi phí
            const totalCost = document.querySelector('.total-cost').innerText;

            // Lấy thông tin peopleType và số lượng tương ứng
            let bookingDetail = '';
            document.querySelectorAll('.people-cost-detail').forEach(function(detail) {
                const peopleType = detail.querySelector('.text-cost-detail').innerText.split('(')[0].trim();

                // Check if the selector is valid for numDetail
                const numDetailElement = detail.querySelector('span[id*="-num-detail"]');
                const totalCostElement = detail.querySelector('span[id*="-total-cost-detail"]');

                if (numDetailElement && totalCostElement) {
                    const numDetail = numDetailElement.innerText;
                    const totalCost = totalCostElement.innerText;
                    bookingDetail += peopleType + ' (x' + numDetail + ');' + totalCost + ';';
                } else {
                    console.log('numDetail or totalCost not found for:', detail);
                }
            });

            // Remove the trailing semicolon and space
            bookingDetail = bookingDetail.trim().slice(0, -1);

            // Debug: Check booking detail
            console.log("Booking Detail: ", bookingDetail);
            // Tạo đối tượng để lưu thông tin gửi đi
            const bookingData = {
                selectedDate: formattedSelectedDate,
                totalCost: totalCost.replace(/[^0-9]/g, ''), // Chỉ lấy số từ giá tiền
                bookingDetail: bookingDetail,
                optionId: optionId,
                discountCost: discountCost
            };

            return bookingData;
        }
        
        function convertDateFormat(dateString) {
            // dateString có định dạng "Monday, 28 Oct 2024"

            // Tách chuỗi để lấy phần ngày, tháng và năm
            const parts = dateString.split(', ')[1].split(' ');

            // parts[0] là ngày, parts[1] là tháng (dạng chữ), parts[2] là năm
            const day = parts[0]; // "28"
            const month = convertMonthToNumber(parts[1]); // "Oct"
            const year = parts[2]; // "2024"

            // Trả về chuỗi định dạng day/month/year
            return day + '/' + month + '/' + year;
        }

        function convertMonthToNumber(month) {
            // Map tháng dạng chữ sang số
            const monthMap = {
                'Jan': '01',
                'Feb': '02',
                'Mar': '03',
                'Apr': '04',
                'May': '05',
                'Jun': '06',
                'Jul': '07',
                'Aug': '08',
                'Sep': '09',
                'Oct': '10',
                'Nov': '11',
                'Dec': '12'
            };

            return monthMap[month];
        }
    </script>




    
    <script>
        function toggle(action) {
            var blur = document.getElementById('blur');

            if (action === 'blur') {
                // Chỉ kích hoạt blur
                blur.classList.toggle('active');
            } else if (action === 'popup1') {
                // Kích hoạt popup 1 và blur
                blur.classList.toggle('active');
                var popup1 = document.getElementById('popup1');
                popup1.classList.toggle('active');
            } else if (action === 'popup2') {
                // Kích hoạt popup 2 và blur
                blur.classList.toggle('active');
                var popup2 = document.getElementById('popup2');
                popup2.classList.toggle('active');
            } else if (action === 'popup3') {
                // Kích hoạt popup 2 và blur
                blur.classList.toggle('active');
                var popup3 = document.getElementById('popup3');
                popup3.classList.toggle('active');
            } else if (action === 'popup4') {
                // Kích hoạt popup 2 và blur
                blur.classList.toggle('active');
                var popup4 = document.getElementById('popup4');
                popup4.classList.toggle('active');
            } else if (action === 'popup5') {
                // Kích hoạt popup 2 và blur
                blur.classList.toggle('active');
                var popup5 = document.getElementById('popup5');
                popup5.classList.toggle('active');
            } else if (action === 'calendar') {
                // Kích hoạt popup 2 và blur
                blur.classList.toggle('active');
                const section = document.getElementById('date-section');
                if (section) {
                    section.scrollLeft -= 600; // Di chuyển về phía trái
                }
            } else {
                // Đóng popup (khi người dùng nhấn nút "Close")
                var popups = document.getElementsByClassName('popup');
                for (var i = 0; i < popups.length; i++) {
                    popups[i].classList.remove('active');
                }
                blur.classList.remove('active');
            }
        }
    </script>

<!--    <script>
        function scrollRight() {
            const section = document.querySelector('.date-section');
            if (section) {
                section.scrollLeft += 200; // Di chuyển về phía phải
            }
        }

        function scrollLeft1() {
            const section = document.querySelector('.date-section');
            if (section) {
                section.scrollLeft -= 200; // Di chuyển về phía trái
            }
        }

        // Lắng nghe sự kiện click ra ngoài popup để tắt hiệu ứng mờ
        document.addEventListener('click', function (event) {
            var calendarElement = document.querySelector('.flatpickr-calendar'); // Lấy popup lịch
            var blurElement = document.getElementById('blur');

            // Kiểm tra nếu click không phải vào popup hoặc nút mở lịch
            if (!calendarElement.contains(event.target) && !event.target.closest('.calendar')) {
                // Xóa lớp mờ nếu người dùng nhấp ra ngoài popup
                if (blurElement.classList.contains('active')) {
                    toggle(null);
                }
            }
        }, true);
    </script>-->

    

    <script>
//        // Convert the previousSelectedDate from the server into a JavaScript Date object
//        let previousSelectedDate = '<%= previousSelectedDate != null ? previousSelectedDate : "" %>';
//        let selectedDate = previousSelectedDate ? new Date(previousSelectedDate) : new Date(); // If no date is passed, use the current date
//        
//        console.log("Preday:" + previousSelectedDate);
//        // Function to display the date range and filter options
//        function displayDateRange(centerDate) {
//            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
//
//            // Tìm tất cả các phần tử .date-container
//            let dateContainers = document.querySelectorAll('.date-container');
//
//            // Vòng lặp để tạo 14 ngày
//            for (let i = 0; i < 14; i++) {
//                let date = new Date(centerDate);
//                date.setDate(centerDate.getDate() + i); // Hiển thị 7 ngày trước và 7 ngày sau
//
//                let dayOfWeek = daysOfWeek[date.getDay()];
//                let formattedDate = date.getDate() + ' thg ' + (date.getMonth() + 1);
//
//                // Cập nhật nội dung của phần tử date-container
//                dateContainers[i].querySelector('[data-dayofweek]').innerText = dayOfWeek;
//                dateContainers[i].querySelector('[data-formatteddate]').innerText = formattedDate;
//
//                // Cập nhật sự kiện onclick với giá trị ngày mới
//                dateContainers[i].onclick = () => selectDate(dateContainers[i], date.toISOString()); // Sử dụng hàm mũi tên
//
//                // Đặt class selected cho ngày hiện tại
//                if (i === 0) {
//                    dateContainers[i].classList.add('selected');
//                } else {
//                    dateContainers[i].classList.remove('selected');
//                }
//            }
//
//            // Cập nhật biến selectedDate thành ngày đã chọn
//            selectedDate = centerDate;
//
//            console.log("Seeeelected Dateee: " + selectedDate);
//
//            filterTourOptions(selectedDate);
//        }
//
//
//        const daysMapping = {
//            'Sunday': 0,
//            'Monday': 1,
//            'Tuesday': 2,
//            'Wednesday': 3,
//            'Thursday': 4,
//            'Friday': 5,
//            'Saturday': 6
//        };
//
//
//        function filterTourOptions(selectedDate) {
//            const dayOfWeek = selectedDate.getDay(); // Lấy số ngày trong tuần từ selectedDate
//            console.log("Selected day of week:", dayOfWeek); // Kiểm tra giá trị ngày đã chọn
//
//            const tourOptions = [...document.querySelectorAll('.tour-option')];
//
//            tourOptions.forEach(option => {
//                const refundSection = option.querySelector('.refund-section').innerText;
//                console.log("Refund section text:", refundSection); // In ra nội dung refund-section
//                const optionDayOfWeek = daysMapping[refundSection]; // Sử dụng ánh xạ để lấy số
//
//                console.log("Option day of week:", optionDayOfWeek); // Kiểm tra giá trị dayOfWeek trong mỗi option
//
//                // Lấy tour_Date từ option
//                const tourDateStr = option.getAttribute('data-tour-date'); // Giả sử bạn lưu trữ tour_Date trong thuộc tính data
//                const tourDate = new Date(tourDateStr); // Chuyển đổi chuỗi ngày thành đối tượng Date
//
//                // Kiểm tra nếu ngày đã chọn và tour_Date cùng ngày
//                if (optionDayOfWeek === dayOfWeek && selectedDate.toDateString() === tourDate.toDateString()) {
//                    option.style.display = 'flex'; // Hiển thị tourOption
//                } else {
//                    option.style.display = 'none'; // Ẩn tourOption
//                }
//            });
//        }
//
//        // Biến lưu thứ trong tuần
//        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
//
//        // Hàm để định dạng ngày theo yêu cầu
//        function formatDateToDisplay(date) {
//            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
//            let dayOfWeek = daysOfWeek[date.getDay()];
//            let formattedDate = dayOfWeek + ', ' + date.getDate() + ' thg ' + (date.getMonth() + 1) + ' ' + date.getFullYear();
//            return formattedDate;
//        }
//
//        // Cập nhật hàm selectDate
//        function selectDate(element, dateStr) {
//            console.log("Date string selected:", dateStr);
//
//            // Xóa class 'selected' khỏi tất cả các ngày
//            let allDates = document.querySelectorAll('.date-container');
//            allDates.forEach(date => date.classList.remove('selected'));
//
//            // Thêm class 'selected' vào phần tử được nhấp vào
//            element.classList.add('selected');
//
//            // Cập nhật ngày đã chọn
//            selectedDate = new Date(dateStr);
//            console.log("Updated selectedDate:", selectedDate);
//
//            // Hiển thị ngày đã chọn trong phần tử .selected-date với định dạng mong muốn
//            let selectedDateElement = document.querySelector('.selected-date');
//            selectedDateElement.innerText = formatDateToDisplay(selectedDate); // Sử dụng hàm formatDateToDisplay
//
//            filterTourOptions(selectedDate);
//        }
//
//        // Function để mở lịch và đặt ngày mặc định
//        function openCalendar() {
//            flatpickr("#calendarInput", {
//                dateFormat: "Y-m-d",
//                defaultDate: new Date(),
//                minDate: "today",
//                onChange: function (selectedDates, dateStr, instance) {
//                    if (selectedDates.length > 0) {
//                        selectedDate = new Date(selectedDates[0]);
//                        
//                        // Hiển thị ngày đã chọn trong phần tử .selected-date khi chọn từ popup lịch
//                        let selectedDateElement = document.querySelector('.selected-date');
//                        selectedDateElement.innerText = formatDateToDisplay(selectedDate); // Định dạng theo yêu cầu
//                        
//                        displayDateRange(selectedDate);
//                    }
//                },
//                onClose: function () {
//                    toggle('calendar');
//                }
//            }).open();
//        }
//
//        // Display the date range on page load
//        window.onload = function () {
//            displayDateRange(selectedDate);
//
//            // Display the selected date in the desired format
//            let selectedDateElement = document.querySelector('.selected-date');
//            selectedDateElement.innerText = formatDateToDisplay(selectedDate);
//        };
//    </script>
    
    <script>
//        const options = document.querySelectorAll('.tour-option');
//        options.forEach(option => {
//            const dayOfWeek = option.getAttribute('data-dayofweek');
//            console.log(dayOfWeek); // Kiểm tra xem giá trị có được in ra không
//        });
//    </script>

    <script>
        document.querySelectorAll('.nav-link').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            });
        });
    </script>
</body>

<%@include file="includes/footer.jsp" %>